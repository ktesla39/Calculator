<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scientific Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- MathJax -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <!-- math.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #101820;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 10px;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #f5f5f5;
      color: #333;
    }
    .calculator {
      background: #1c1f26;
      padding: 20px;
      border-radius: 15px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      transition: background 0.3s;
    }
    .calculator.light {
      background: #fff;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
    }
    .display {
      background: #000;
      color: #0f0;
      padding: 15px;
      font-size: 1.4rem;
      border-radius: 10px;
      min-height: 60px;
      overflow-x: auto;
      white-space: nowrap;
      text-align: right;
      font-family: 'Courier New', monospace;
      transition: background 0.3s, color 0.3s;
    }
    .calculator.light .display {
      background: #e0e0e0;
      color: #000;
    }
    .latex {
      color: #0ff;
      margin-top: 8px;
      font-size: 1.1rem;
      min-height: 28px;
      overflow-x: auto;
      text-align: right;
      transition: color 0.3s;
    }
    .calculator.light .latex {
      color: #008080;
    }
    .button-group {
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
    }
    .calculator.light .button-group {
      background: rgba(0,0,0,0.05);
    }
    .buttons {
      display: grid;
      gap: 8px;
    }
    .number-grid { grid-template-columns: repeat(4, 1fr); }
    .operator-grid { grid-template-columns: repeat(4, 1fr); }
    .trig-grid { grid-template-columns: repeat(3, 1fr); }
    .log-grid { grid-template-columns: repeat(2, 1fr); }
    .power-grid { grid-template-columns: repeat(3, 1fr); }
    .memory-grid { grid-template-columns: repeat(4, 1fr); }
    .control-grid { grid-template-columns: repeat(4, 1fr); }
    button {
      padding: 12px;
      font-size: 0.95rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.1s, opacity 0.2s, background 0.2s;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }
    button:active::after {
      width: 200%;
      height: 200%;
    }
    button:active {
      transform: scale(0.95);
    }
    .num { background: #2d472d; color: white; }
    .func { background: #2d3f5e; color: white; }
    .control { background: #5e2d2d; color: white; }
    .special { background: #5e5a2d; color: white; }
    .memory { background: #4a2d5e; color: white; }
    .shift-active, .mode-active { background: #ff9800; color: white; }
    .calculator.light .num { background: #4CAF50; }
    .calculator.light .func { background: #2196F3; }
    .calculator.light .control { background: #F44336; }
    .calculator.light .special { background: #FFC107; }
    .calculator.light .memory { background: #9C27B0; }
    .calculator.light .shift-active, .calculator.light .mode-active { background: #FF5722; }
    button:hover {
      opacity: 0.9;
    }
    .mode-select {
      margin: 10px 0;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    select, .toggle-button {
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 0.95rem;
      background: #2d3f5e;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .calculator.light select, .calculator.light .toggle-button {
      background: #2196F3;
    }
    .history {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      background: #000;
      padding: 10px;
      border-radius: 10px;
      font-size: 0.9rem;
      color: #0f0;
      font-family: 'Courier New', monospace;
      transition: background 0.3s, color 0.3s;
    }
    .calculator.light .history {
      background: #e0e0e0;
      color: #000;
    }
    .history-item {
      cursor: pointer;
      padding: 5px;
      border-bottom: 1px solid #333;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .calculator.light .history-item {
      border-bottom: 1px solid #ccc;
    }
    .history-item:hover {
      background: #1c1f26;
    }
    .calculator.light .history-item:hover {
      background: #d0d0d0;
    }
    .history-timestamp {
      font-size: 0.75rem;
      color: #888;
    }
    @media (max-width: 480px) {
      .calculator { padding: 12px; max-width: 360px; }
      button, select, .toggle-button {
        padding: 8px;
        font-size: 0.8rem;
      }
      .display { font-size: 1.2rem; }
      .latex { font-size: 0.95rem; }
      .history { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function Calculator() {
      const [expression, setExpression] = useState('');
      const [result, setResult] = useState('');
      const [shift, setShift] = useState(false);
      const [lastAns, setLastAns] = useState('0');
      const [mode, setMode] = useState('deg');
      const [displayMode, setDisplayMode] = useState('decimal');
      const [calcMode, setCalcMode] = useState(() => {
        try {
          return localStorage.getItem('calcMode') || 'scientific';
        } catch {
          return 'scientific';
        }
      });
      const [history, setHistory] = useState(() => {
        try {
          return JSON.parse(localStorage.getItem('calcHistory')) || [];
        } catch {
          return [];
        }
      });
      const [memory, setMemory] = useState(0);
      const [theme, setTheme] = useState('dark');
      const debounceTimer = useRef(null);
      const latexRef = useRef(null);

      const toRadians = (val) => {
        if (typeof val !== 'number') return val;
        if (mode === 'deg') return (val * Math.PI) / 180;
        if (mode === 'grad') return (val * Math.PI) / 200;
        return val;
      };

      const fromRadians = (val) => {
        if (typeof val !== 'number') return val;
        if (mode === 'deg') return (val * 180) / Math.PI;
        if (mode === 'grad') return (val * 200) / Math.PI;
        return val;
      };

      const toFraction = (num) => {
        if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return num.toString();
        const tolerance = 1.0e-6;
        let h1 = 1, h2 = 0, k1 = 0, k2 = 1, a = num;
        do {
          const n = Math.floor(a);
          let aux = h1; h1 = n * h1 + h2; h2 = aux;
          aux = k1; k1 = n * k1 + k2; k2 = aux;
          a = 1 / (a - n);
        } while (Math.abs(num - h1 / k1) > num * tolerance && k1 < 1000);
        return k1 === 1 ? h1.toString() : `${h1}/${k1}`;
      };

      const formatNumber = (num) => {
        if (typeof num !== 'number' || isNaN(num) || !isFinite(num)) return num.toString();
        if (displayMode === 'fraction') return toFraction(num);
        return Number(num.toPrecision(10)).toString();
      };

      const autoCloseParentheses = (expr) => {
        let openCount = 0;
        for (let char of expr) {
          if (char === '(') openCount++;
          if (char === ')') openCount--;
        }
        return expr + ')'.repeat(Math.max(0, openCount));
      };

      const evaluateExpression = (expr) => {
        if (!expr) return '';
        try {
          let exp = expr
            .replace(/π/g, 'pi')
            .replace(/Ans/g, lastAns)
            .replace(/(\d+)!/g, 'factorial($1)')
            .replace(/(\d+)√(\d+)/g, 'nthRoot($2,$1)')
            .replace(/√(\d+)/g, 'sqrt($1)')
            .replace(/sin\^-1/g, 'asin')
            .replace(/cos\^-1/g, 'acos')
            .replace(/tan\^-1/g, 'atan')
            .replace(/(\d+)\^(\d+)/g, '($1)^($2)')
            .replace(/(\d+)\/(\d+)/g, '($1)/($2)')
            .replace(/e\^(\d+)/g, 'exp($1)')
            .replace(/10\^(\d+)/g, 'pow(10,$1)')
            .replace(/(\d+)\^2/g, '($1)^(2)')
            .replace(/(\d+)\^3/g, '($1)^(3)');

          exp = autoCloseParentheses(exp);

          const customMath = math.create(math.all);
          customMath.import({
            sin: (x) => Math.sin(toRadians(x)),
            cos: (x) => Math.cos(toRadians(x)),
            tan: (x) => Math.tan(toRadians(x)),
            asin: (x) => fromRadians(Math.asin(x)),
            acos: (x) => fromRadians(Math.acos(x)),
            atan: (x) => fromRadians(Math.atan(x)),
            log: (x) => Math.log10(x),
            ln: (x) => Math.log(x),
            exp: Math.exp,
            factorial: math.factorial,
            nthRoot: math.nthRoot,
            sqrt: math.sqrt,
            pi: Math.PI,
            e: Math.E,
          }, { override: true });

          const val = customMath.evaluate(exp);
          if (val === Infinity || val === -Infinity) throw new Error('Infinity');
          const formatted = formatNumber(val);
          setLastAns(formatted);
          setResult(formatted);
          if (formatted !== 'Error' && expr) {
            const newHistory = [...history, { expr, result: formatted, timestamp: new Date().toISOString() }].slice(-50);
            setHistory(newHistory);
            localStorage.setItem('calcHistory', JSON.stringify(newHistory));
          }
          return formatted;
        } catch (e) {
          setResult('Error');
          return 'Error';
        }
      };

      const updateLatex = (expr, res) => {
        if (!latexRef.current || !expr || res === 'Error' || res === '') return;
        try {
          let latexExpr = expr
            .replace(/\*/g, '\\times ')
            .replace(/(\d+)\/(\d+)/g, '\\frac{$1}{$2}')
            .replace(/√(\d+)/g, '\\sqrt{$1}')
            .replace(/(\d+)√(\d+)/g, '\\sqrt[$1]{$2}')
            .replace(/π/g, '\\pi ')
            .replace(/(\d+)\^(\d+)/g, '{${1}}^{${2}}')
            .replace(/sin\^-1/g, '\\sin^{-1}')
            .replace(/cos\^-1/g, '\\cos^{-1}')
            .replace(/tan\^-1/g, '\\tan^{-1}')
            .replace(/e\^(\d+)/g, 'e^{$1}')
            .replace(/10\^(\d+)/g, '10^{$1}')
            .replace(/(\d+)\^2/g, '{${1}}^{2}')
            .replace(/(\d+)\^3/g, '{${1}}^{3}');
          
          const display = res
  ? `${latexExpr} = ${displayMode === 'fraction' && res.includes('/') 
      ? `\\frac{${res.split('/')[0]}}{${res.split('/')[1]}}`
      : res}`
  : latexExpr;

          latexRef.current.innerHTML = '';
          const node = MathJax.tex2chtml(display, { display: false });  // Inline mode, no surrounding \( \)

          latexRef.current.appendChild(node);
          MathJax.typesetPromise([latexRef.current]).catch(() => {});
        } catch {}
      };

      const handleClick = (val) => {
        if (val === 'C') {
          setExpression('');
          setResult('');
          if (latexRef.current) latexRef.current.innerHTML = '';
        } else if (val === 'DEL') {
          setExpression(prev => prev.slice(0, -1));
        } else if (val === '=') {
          const val = evaluateExpression(expression);
          if (val !== 'Error') updateLatex(expression, val);
        } else if (val === 'shift') {
          setShift(s => !s);
        } else if (val === 'S<=>D') {
          setDisplayMode(prev => prev === 'decimal' ? 'fraction' : 'decimal');
          if (result && result !== 'Error') {
            const val = evaluateExpression(expression);
            if (val !== 'Error') updateLatex(expression, val);
          }
        } else if (val === 'M+') {
          try {
            const val = parseFloat(result) || 0;
            setMemory(prev => prev + val);
          } catch {}
        } else if (val === 'M-') {
          try {
            const val = parseFloat(result) || 0;
            setMemory(prev => prev - val);
          } catch {}
        } else if (val === 'MR') {
          setExpression(prev => prev + memory.toString());
        } else if (val === 'MC') {
          setMemory(0);
        } else if (val === 'theme') {
          setTheme(prev => prev === 'dark' ? 'light' : 'dark');
        } else if (val === 'modeToggle') {
          const newMode = calcMode === 'scientific' ? 'normal' : 'scientific';
          setCalcMode(newMode);
          localStorage.setItem('calcMode', newMode);
          if (newMode === 'normal') {
            setMode('deg'); // Reset angle mode in normal mode
            setDisplayMode('decimal'); // Reset display mode in normal mode
          }
        } else if (val === 'clearHistory') {
          setHistory([]);
          localStorage.setItem('calcHistory', JSON.stringify([]));
        } else {
          setExpression(prev => prev + val);
        }
      };

      const handleHistoryClick = (item) => {
        setExpression(item.expr);
        setResult(item.result);
        updateLatex(item.expr, item.result);
      };

      useEffect(() => {
        document.body.className = theme;
      }, [theme]);

      useEffect(() => {
        if (debounceTimer.current) clearTimeout(debounceTimer.current);
        if (!expression) {
          setResult('');
          if (latexRef.current) latexRef.current.innerHTML = '';
          return;
        }
        debounceTimer.current = setTimeout(() => {
          const val = evaluateExpression(expression);
          if (val !== 'Error') updateLatex(expression, val);
        }, 500);
        return () => clearTimeout(debounceTimer.current);
      }, [expression, mode, displayMode]);

      useEffect(() => {
        const onKeyDown = (e) => {
          e.preventDefault();
          const keyMap = {
            'Enter': '=',
            'Backspace': 'DEL',
            'Escape': 'C',
            'Delete': 'C',
            'm': 'M+',
            'n': 'M-',
            'r': 'MR',
            'c': 'MC',
            'e': 'e^',
            't': '10^',
            's': '^2',
            'q': '^3',
            'Shift': 'shift',
            'o': 'modeToggle',
          };
          if (keyMap[e.key]) {
            handleClick(keyMap[e.key]);
          } else if (/[0-9+\-*/().^eπ]/.test(e.key)) {
            handleClick(e.key);
          }
        };
        document.addEventListener('keydown', onKeyDown);
        return () => document.removeEventListener('keydown', onKeyDown);
      }, [expression, memory]);

      const buttonGroups = {
        control: [
          { label: 'C', class: 'control' },
          { label: 'DEL', class: 'control' },
          { label: 'shift', class: shift ? 'shift-active' : 'special' },
          { label: 'modeToggle', class: calcMode === 'scientific' ? 'mode-active' : 'special' },
        ],
        numbers: [
          { label: '7', class: 'num' },
          { label: '8', class: 'num' },
          { label: '9', class: 'num' },
          { label: '4', class: 'num' },
          { label: '5', class: 'num' },
          { label: '6', class: 'num' },
          { label: '1', class: 'num' },
          { label: '2', class: 'num' },
          { label: '3', class: 'num' },
          { label: '0', class: 'num' },
          { label: '.', class: 'num' },
          { label: 'π', class: 'num', hideInNormal: true },
          { label: 'e', class: 'num', hideInNormal: true },
        ],
        operators: [
          { label: '+', class: 'func' },
          { label: '-', class: 'func' },
          { label: '*', class: 'func' },
          { label: '/', class: 'func' },
        ],
        trigonometry: [
          { label: shift ? 'sin^-1(' : 'sin(', class: 'func', hideInNormal: true },
          { label: shift ? 'cos^-1(' : 'cos(', class: 'func', hideInNormal: true },
          { label: shift ? 'tan^-1(' : 'tan(', class: 'func', hideInNormal: true },
        ],
        logarithms: [
          { label: shift ? 'log(' : 'ln(', class: 'func', hideInNormal: true },
          { label: shift ? '10^' : 'e^', class: 'func', hideInNormal: true },
        ],
        powers: [
          { label: '^', class: 'func', hideInNormal: true },
          { label: shift ? '^3' : '^2', class: 'func', hideInNormal: true },
          { label: '!', class: 'func', hideInNormal: true },
        ],
        memory: [
          { label: 'M+', class: 'memory' },
          { label: 'M-', class: 'memory' },
          { label: 'MR', class: 'memory' },
          { label: 'MC', class: 'memory' },
        ],
      };

      return (
        <div className={`calculator ${theme}`}>
          <div className="display" title={expression}>{expression || '0'}</div>
          <div className="latex" ref={latexRef}></div>
          <div className="mode-select">
            {calcMode === 'scientific' && (
              <div>
                Angle Mode:
                <select value={mode} onChange={e => setMode(e.target.value)}>
                  <option value="deg">Degree</option>
                  <option value="rad">Radian</option>
                  <option value="grad">Gradian</option>
                </select>
              </div>
            )}
            <button className="toggle-button" onClick={() => handleClick('S<=>D')}>
              {displayMode === 'decimal' ? 'S=>D' : 'S<=D'}
            </button>
            <button className="toggle-button" onClick={() => handleClick('theme')}>
              {theme === 'dark' ? '☀' : '☽'} Mode
            </button>
          </div>
          <div className="button-group control-grid buttons">
            {buttonGroups.control.map((btn, i) => (
              <button
                key={`control-${i}`}
                className={btn.class}
                onClick={() => handleClick(btn.label)}
                disabled={!btn.label}
              >
                {btn.label === 'modeToggle' ? (calcMode === 'scientific' ? 'Sci' : 'Norm') : btn.label}
              </button>
            ))}
          </div>
          <div className="button-group number-grid buttons">
            {buttonGroups.numbers
              .filter(btn => !btn.hideInNormal || calcMode === 'scientific')
              .map((btn, i) => (
                <button
                  key={`num-${i}`}
                  className={btn.class}
                  onClick={() => handleClick(btn.label)}
                  disabled={!btn.label}
                >
                  {btn.label}
                </button>
              ))}
          </div>
          <div className="button-group operator-grid buttons">
            {buttonGroups.operators.map((btn, i) => (
              <button
                key={`op-${i}`}
                className={btn.class}
                onClick={() => handleClick(btn.label)}
                disabled={!btn.label}
              >
                {btn.label}
              </button>
            ))}
          </div>
          {calcMode === 'scientific' && (
            <>
              <div className="button-group trig-grid buttons">
                {buttonGroups.trigonometry.map((btn, i) => (
                  <button
                    key={`trig-${i}`}
                    className={btn.class}
                    onClick={() => handleClick(btn.label)}
                    disabled={!btn.label}
                  >
                    {btn.label}
                  </button>
                ))}
              </div>
              <div className="button-group log-grid buttons">
                {buttonGroups.logarithms.map((btn, i) => (
                  <button
                    key={`log-${i}`}
                    className={btn.class}
                    onClick={() => handleClick(btn.label)}
                    disabled={!btn.label}
                  >
                    {btn.label}
                  </button>
                ))}
              </div>
              <div className="button-group power-grid buttons">
                {buttonGroups.powers.map((btn, i) => (
                  <button
                    key={`pow-${i}`}
                    className={btn.class}
                    onClick={() => handleClick(btn.label)}
                    disabled={!btn.label}
                  >
                    {btn.label}
                  </button>
                ))}
              </div>
            </>
          )}
          <div className="button-group memory-grid buttons">
            {buttonGroups.memory.map((btn, i) => (
              <button
                key={`mem-${i}`}
                className={btn.class}
                onClick={() => handleClick(btn.label)}
                disabled={!btn.label}
              >
                {btn.label}
              </button>
            ))}
          </div>
          <div className="history">
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <span>History:</span>
              <button className="toggle-button" onClick={() => handleClick('clearHistory')}>
                Clear History
              </button>
            </div>
            {history.length === 0 && <div>No history yet</div>}
            {history.map((item, i) => (
              <div
                key={i}
                className="history-item"
                onClick={() => handleHistoryClick(item)}
              >
                <span>{item.expr} = {item.result}</span>
                <span className="history-timestamp">
                  {new Date(item.timestamp).toLocaleTimeString()}
                </span>
              </div>
            ))}
          </div>
          <div style={{ marginTop: 10, fontSize: 14, color: theme === 'dark' ? '#888' : '#666', textAlign: 'center' }}>
            *Auto-evaluates after 0.5s pause. Press = to force evaluate. Click history to reuse.
            <br />
            Memory: {memory} | Keyboard: m(M+), n(M-), r(MR), c(MC), e(e^), t(10^), s(x²), q(x³), Shift(shift), o(mode)
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Calculator />);
  </script>
</body>
</html>